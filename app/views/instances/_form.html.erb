<%= form_for(@instance) do |f| %>
  <% if @instance.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@instance.errors.count, "error") %> prohibited this instance from being saved:</h2>

      <ul>
      <% @instance.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <%= f.hidden_field(:entity_id) %>

  <div class="field">
    <%= f.label :section_id %><br>
    <%= f.collection_select(:section_id, Section.all, :id, :titolo) %>
  </div>
  <div class="field">
    <%= f.label :tags %><br>
    <%= f.text_field :tags %>
  </div>

  <% @entity.properties.each do |property| %>
        <%
          field_id = "dato[#{ property.id }]"
          tipo = property.tipo

          if @instance
            dato = Datum.find_by instance_id: @instance.id, property_id: property.id
            valore = dato ? dato.valore : ''
          else
            valore = ''
          end

          etichetta = label_tag field_id, property.nome
          br = '<br>'.html_safe

          case tipo
            when 'stringa'
              tag = etichetta + br + ( text_field_tag field_id, valore )
            when 'testo'
              tag = etichetta + br + ( text_area_tag field_id, valore )
            when 'email'
              tag = etichetta + br + ( email_field_tag field_id, valore )
            when 'telefono'
              tag = etichetta + br + ( telephone_field_tag field_id, valore )
            when 'url'
              tag = etichetta + br + ( url_field_tag field_id, valore )
            when 'check' # check_box_tag(name, value = "1", checked = false, options = {})
              tag = ( check_box_tag field_id, '1', valore=='1' ? true : false ) + etichetta
            when 'lista'
              tag = etichetta + br + ( select_tag field_id, options_for_select("opzione 1,opzione 2,opzione 3".split(','), valore) )
            when 'intero'
              tag = etichetta + br + ( number_field_tag field_id, valore, step: 1 )
            when 'sesso' # radio_button_tag(name, value, checked = false, options = {})
              tag = (radio_button_tag field_id, 'm', valore=='m' ? true : false) + ( label_tag field_id, 'm' ) +
                    (radio_button_tag field_id, 'f', valore=='f' ? true : false) + ( label_tag field_id, 'f' )
            when 'data'
              tag = etichetta + br + ( date_field_tag field_id, valore )
            else
              '<b>Propriet√† non valida!</b>'
          end
        %>
        <%= tag %>

  <% end %>

  <div class="actions">
  <%= f.submit %>
  </div>
<% end %>
